<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script
      crossorigin
      src="https://unpkg.com/react@18.3.1/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-query/dist/react-query.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/@babel/standalone/babel.min.js"
    ></script>
    <style>
      html {
        background: #667eea;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 20px;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        opacity: 0;
        animation: fadeIn 0.3s ease-in forwards;
        animation-delay: 0.1s;
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }
      .card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        text-align: center;
        max-width: 400px;
        width: 90%;
      }
      h1 {
        margin: 0 0 20px 0;
        font-size: 2em;
      }
      p {
        font-size: 1.2em;
        margin: 20px 0;
      }
      button {
        background: white;
        color: #667eea;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
      }
      button:active {
        transform: scale(0.95);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .mutation-info {
        margin-top: 20px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
      }
      .code-example {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 0.85em;
        margin: 10px 0;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- <script type="text/javascript"> -->
    <script type="text/babel">
      const { useState, useEffect } = React;
      const { QueryClient, QueryClientProvider, useQuery, useMutation } =
        window.ReactQuery;

      const queryClient = new QueryClient({
        defaultOptions: {
          queries: {
            refetchOnWindowFocus: false,
            retry: 1,
          },
        },
      });

      // Custom hook for React Native message stream (similar to EventSource pattern)
      const useReactNativeMessageStream = (queryKey) => {
        useEffect(() => {
          const handleMessage = (event) => {
            try {
              let data;
              // Handle both string and object data
              if (typeof event.data === "string") {
                try {
                  data = JSON.parse(event.data);
                } catch {
                  // Treat as plain string message
                  data = { text: event.data, type: "SIMPLE_MESSAGE" };
                }
              } else {
                data = event.data;
              }

              // Get current messages from cache
              const currentMessages = queryClient.getQueryData(queryKey) || [];

              // Create new message
              const newMessage = {
                id: Date.now(),
                text: data.text || event.data,
                from: data.source || "React Native",
                type: data.type || "SIMPLE_MESSAGE",
                timestamp: data.timestamp || new Date().toISOString(),
              };

              // Update query cache with new message stream
              queryClient.setQueryData(queryKey, [
                ...currentMessages,
                newMessage,
              ]);
            } catch (error) {
              console.error("Error processing message stream:", error);
            }
          };

          // Set up message stream listeners (similar to EventSource pattern)
          document.addEventListener("message", handleMessage);
          window.addEventListener("message", handleMessage);

          return () => {
            document.removeEventListener("message", handleMessage);
            window.removeEventListener("message", handleMessage);
          };
        }, [queryKey]);

        // Return query for the message stream
        return useQuery({
          queryKey,
          queryFn: () => [], // Initialize with empty array
          initialData: [],
        });
      };

      function Card() {
        // Use the custom message stream hook
        const messageStreamQuery = useReactNativeMessageStream([
          "messageStream",
        ]);
        const messages = messageStreamQuery.data || [];

        // Advanced: Mutation with acknowledgment pattern
        const sendWithAckMutation = useMutation({
          mutationFn: async (messageData) => {
            return new Promise((resolve, reject) => {
              const messageId = `ack_${Date.now()}`;
              const timeout = setTimeout(() => {
                reject(
                  new Error("Timeout: No acknowledgment from React Native"),
                );
              }, 5000);

              // One-time listener for acknowledgment
              const handleAck = (event) => {
                try {
                  let data;
                  // Handle both string and object data
                  if (typeof event.data === "string") {
                    data = JSON.parse(event.data);
                  } else {
                    data = event.data;
                  }

                  if (data.type === "ACK" && data.originalId === messageId) {
                    clearTimeout(timeout);
                    document.removeEventListener("message", handleAck);
                    window.removeEventListener("message", handleAck);
                    resolve(data);
                  }
                } catch (e) {
                  // Not our message, ignore
                  console.log("Ignoring non-JSON message:", event.data);
                }
              };

              document.addEventListener("message", handleAck);
              window.addEventListener("message", handleAck);

              // Send message
              const message = {
                id: messageId,
                type: "REQUIRES_ACK",
                data: messageData,
                timestamp: new Date().toISOString(),
              };

              if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify(message));
              } else {
                clearTimeout(timeout);
                reject(new Error("ReactNativeWebView not available"));
              }
            });
          },
          onSuccess: (ackData) => {
            console.log("Received ACK:", ackData);
            // Update message stream via query cache
            const currentMessages =
              queryClient.getQueryData(["messageStream"]) || [];
            const ackMessage = {
              id: Date.now(),
              text: `ACK received! Status: ${ackData.status}`,
              from: "System",
              type: "ACK_RESPONSE",
              timestamp: new Date().toISOString(),
            };
            queryClient.setQueryData(
              ["messageStream"],
              [...currentMessages, ackMessage],
            );

            // Clear success after 3 seconds
            setTimeout(() => {
              sendWithAckMutation.reset();
            }, 3000);
          },
          onError: (error) => {
            console.error("ACK failed:", error);
            setTimeout(() => {
              sendWithAckMutation.reset();
            }, 3000);
          },
        });

        // Messages are now handled by the useReactNativeMessageStream hook

        // Data stream is now initiated from React Native

        const clearMessageStream = () => {
          queryClient.setQueryData(["messageStream"], []);
        };

        return (
          <div className="card">
            <div className="mutation-info">
              <h4 style={{ margin: "0 0 10px 0" }}>
                Real-time Message Stream (React Query Pattern):
              </h4>

              <div
                style={{
                  marginBottom: "15px",
                  fontSize: "0.9em",
                  color: "rgba(255,255,255,0.8)",
                }}
              >
                <strong>Stream Status:</strong>{" "}
                {messageStreamQuery.isLoading ? "Loading..." : "Connected"} |
                <strong> Messages:</strong> {messages.length} |
                <strong> Last Updated:</strong>{" "}
                {messageStreamQuery.dataUpdatedAt
                  ? new Date(
                      messageStreamQuery.dataUpdatedAt,
                    ).toLocaleTimeString()
                  : "Never"}
              </div>

              <div
                style={{
                  marginBottom: "15px",
                  display: "flex",
                  flexWrap: "wrap",
                  gap: "10px",
                }}
              >
                <button
                  onClick={clearMessageStream}
                  style={{
                    fontSize: "0.9em",
                    padding: "8px 16px",
                    background: "#ff6b6b",
                    color: "white",
                    border: "none",
                    borderRadius: "5px",
                  }}
                >
                  üóëÔ∏è Clear Stream
                </button>

                <button
                  onClick={() =>
                    sendWithAckMutation.mutate(
                      "Important message requiring acknowledgment",
                    )
                  }
                  disabled={sendWithAckMutation.isLoading}
                  style={{
                    fontSize: "0.9em",
                    padding: "8px 16px",
                    background: sendWithAckMutation.isLoading
                      ? "#ccc"
                      : "white",
                    color: sendWithAckMutation.isLoading ? "#666" : "#667eea",
                    border: "none",
                    borderRadius: "5px",
                  }}
                >
                  {sendWithAckMutation.isLoading
                    ? "Waiting for ACK..."
                    : "ü§ù Send with ACK"}
                </button>
                {sendWithAckMutation.isError && (
                  <p
                    style={{
                      color: "#ff6b6b",
                      fontSize: "0.8em",
                      marginTop: "5px",
                    }}
                  >
                    {sendWithAckMutation.error?.message}
                  </p>
                )}
                {sendWithAckMutation.isSuccess && (
                  <p
                    style={{
                      color: "#51cf66",
                      fontSize: "0.8em",
                      marginTop: "5px",
                    }}
                  >
                    ‚úì Acknowledgment received from React Native!
                  </p>
                )}
              </div>
            </div>

            <div style={{ marginTop: "20px", textAlign: "left" }}>
              <h3>Real-time Message Stream ({messages.length} messages):</h3>
              <div
                style={{
                  background: "rgba(0,0,0,0.2)",
                  padding: "10px",
                  borderRadius: "10px",
                  maxHeight: "250px",
                  overflowY: "auto",
                }}
              >
                {messages.length === 0 ? (
                  <p style={{ margin: 0, opacity: 0.7 }}>
                    No messages in stream... Click "üì° Start Data Stream" in the React Native app above to see the React Query pattern in action!
                  </p>
                ) : (
                  messages.map((msg) => {
                    const getMessageStyle = (type) => {
                      switch (type) {
                        case "STREAM_DATA":
                          return {
                            borderLeft: "3px solid #4ecdc4",
                            paddingLeft: "8px",
                            background: "rgba(78, 205, 196, 0.1)",
                          };
                        case "STREAM_COMPLETE":
                          return {
                            borderLeft: "3px solid #51cf66",
                            paddingLeft: "8px",
                            background: "rgba(81, 207, 102, 0.2)",
                          };
                        case "ACK_RESPONSE":
                          return {
                            borderLeft: "3px solid #51cf66",
                            paddingLeft: "8px",
                            background: "rgba(81, 207, 102, 0.1)",
                          };
                        case "SIMPLE_MESSAGE":
                          return {
                            borderLeft: "3px solid #ffd43b",
                            paddingLeft: "8px",
                            background: "rgba(255, 212, 59, 0.1)",
                          };
                        default:
                          return {
                            borderLeft: "3px solid #868e96",
                            paddingLeft: "8px",
                            background: "rgba(134, 142, 150, 0.1)",
                          };
                      }
                    };

                    return (
                      <div
                        key={msg.id}
                        style={{
                          marginBottom: "8px",
                          fontSize: "0.9em",
                          ...getMessageStyle(msg.type),
                        }}
                      >
                        <div
                          style={{
                            display: "flex",
                            justifyContent: "space-between",
                            alignItems: "center",
                          }}
                        >
                          <div>
                            <strong style={{ color: "#fff" }}>
                              {msg.from}:
                            </strong>{" "}
                            <span style={{ marginLeft: "5px" }}>
                              {msg.text}
                            </span>
                          </div>
                          <small style={{ opacity: 0.6, fontSize: "0.8em" }}>
                            {msg.timestamp
                              ? new Date(msg.timestamp).toLocaleTimeString()
                              : ""}
                          </small>
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
            </div>
          </div>
        );
      }

      function App() {
        return (
          <QueryClientProvider client={queryClient}>
            <Card />
          </QueryClientProvider>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
